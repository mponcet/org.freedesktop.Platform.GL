{
    "id": "org.freedesktop.Platform.GL.default",
    "branch": "1.6",
    "runtime": "org.freedesktop.Platform",
    "build-extension": true,
    "sdk": "org.freedesktop.Sdk",
    "runtime-version": "18.08",
    "sdk-extensions": [],
    "separate-locales": false,
    "cleanup": [  "/include", "/share/man" ],
    "build-options" : {
        "no-debuginfo": true,
        "strip": true,
        "prefix": "/usr/lib/x86_64-linux-gnu/GL/default",
        "env": {
            "V": "1",
            "PKG_CONFIG_LIBGLVND_DATADIR": "/usr/lib/x86_64-linux-gnu/GL/default",
            "PKG_CONFIG_PATH": "/usr/lib/x86_64-linux-gnu/GL/default/lib/pkgconfig:/app/lib/pkgconfig:/app/share/pkgconfig:/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig"
        }
    },
    "modules": [
        {
            "name": "llvm-libs",
            "buildsystem": "cmake-ninja",
            "builddir": true,
            "cleanup-platform": ["*"],
            "build-options" : {
                "env": {
                    /* Override global values */
                    "CFLAGS": "",
                    "CXXFLAGS": "",
                    "LDFLAGS": ""
                },
                "arch" : {
                    "i386" : {
                        "config-opts" : [
                            "-DLLVM_TARGETS_TO_BUILD=X86;AMDGPU;NVPTX"
                        ]
                    },
                    "x86_64" : {
                        "config-opts" : [
                            "-DLLVM_TARGETS_TO_BUILD=X86;AMDGPU;NVPTX"
                        ]
                    },
                    "arm" : {
                        "config-opts" : [
                            "-DLLVM_TARGETS_TO_BUILD=ARM;AMDGPU;NVPTX"
                        ]
                    },
                    "aarch64" : {
                        "config-opts" : [
                            "-DLLVM_TARGETS_TO_BUILD=AArch64;AMDGPU;NVPTX"
                        ]
                    }
                }
            },
            "config-opts": [
                "-DLLVM_ENABLE_ASSERTIONS:BOOL=OFF",
                "-DBUILD_SHARED_LIBS:BOOL=OFF",
                "-DCMAKE_BUILD_TYPE=Release",
                "-DLLVM_LIBDIR_SUFFIX=",
                "-DLLVM_ENABLE_LIBCXX:BOOL=OFF",
                "-DLLVM_ENABLE_ZLIB:BOOL=ON",
                "-DLLVM_ENABLE_FFI:BOOL=ON",
                "-DLLVM_INCLUDE_TESTS:BOOL=OFF",
                "-DLLVM_BUILD_TOOLS:BOOL=ON",
                "-DLLVM_INCLUDE_EXAMPLES:BOOL=OFF",
                "-DLLVM_INCLUDE_UTILS:BOOL=OFF",
                "-DLLVM_INCLUDE_DOCS:BOOL=OFF",
                "-DLLVM_ENABLE_DOXYGEN:BOOL=OFF",
                "-DLLVM_BUILD_EXTERNAL_COMPILER_RT:BOOL=ON",
                "-DFFI_INCLUDE_DIR=/usr/lib/x86_64-linux-gnu/libffi-3.2.1/include",
                "-DLLVM_INSTALL_TOOLCHAIN_ONLY:BOOL=OFF"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://git.llvm.org/git/llvm"
                }
            ]
        },
        {
            "name": "libdrm",
            "config-opts": [ "--disable-static", "--disable-udev" ],
            "sources": [
                 {
                     "type": "git",
                     "url": "https://gitlab.freedesktop.org/mesa/drm"
                 }
            ]
        },
        {
            "name": "libglvnd",
            "config-opts": [ "--disable-static", "--enable-asm", "--enable-tls" ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/NVIDIA/libglvnd.git"
                }
            ]
        },
        {
            "name": "mesa",
            "build-options" : {
                "cxxflags": "-fno-rtti -fno-exceptions",
                "arch" : {
                    "i386" : {
                        "config-opts" : [
                            "--build=i586-unknown-linux-gnu",
                            "--with-gallium-drivers=svga,swrast,radeonsi,nouveau,r600,r300,radeonsi,virgl",
                            "--with-dri-drivers=swrast,nouveau,radeon,r200,i915,i965",
                            "--with-vulkan-drivers=intel,radeon"
                        ]
                    },
                    "x86_64" : {
                        "config-opts" : [
                            "--with-gallium-drivers=svga,swrast,radeonsi,nouveau,r600,r300,radeonsi,virgl",
                            "--with-dri-drivers=swrast,nouveau,radeon,r200,i915,i965",
                            "--with-vulkan-drivers=intel,radeon"
                        ]
                    },
                    "arm" : {
                        "config-opts" : [
                        "--with-gallium-drivers=swrast,nouveau,freedreno,vc4",
                        "--with-dri-drivers=swrast,nouveau,radeon,r200"
                        ]
                    },
                    "aarch64" : {
                        "config-opts" : [
                            "--with-gallium-drivers=swrast,nouveau,freedreno,vc4",
                            "--with-dri-drivers=swrast,nouveau,radeon,r200"
                        ]
                    }
                }
            },
            "config-opts": [
                "--enable-libglvnd",
                "--disable-selinux",
                "--disable-osmesa",
                "--enable-egl",
                "--disable-gles1",
                "--enable-gles2",
                "--enable-vdpau",
                "--enable-va",
                "--enable-xa",
                "--disable-xvmc",
                "--with-platforms=x11,drm,surfaceless,wayland",
                "--enable-shared-glapi",
                "--enable-gbm",
                "--disable-opencl",
                "--enable-glx-tls",
                "--enable-texture-float=yes",
                "--enable-llvm",
                "--with-llvm-prefix=/usr/lib/x86_64-linux-gnu/GL/default",
                "--disable-llvm-shared-libs",
                "--enable-dri",
                "--enable-sysfs"
            ],
            "make-args": [ "MKDEP=/bin/true"],
            "post-install": [
                /* Strip the dri drivers to avoid breaking the hardlinks later */
                "for i in /usr/lib/x86_64-linux-gnu/GL/default/lib/vdpau/*.so.1.0.0 /usr/lib/x86_64-linux-gnu/GL/default/lib/dri/*.so; do cp $i $i.tmp; eu-strip $i.tmp; mv $i.tmp $i; done",
                /* Set the default driver to mesa */
                "ln -s libEGL_mesa.so /usr/lib/x86_64-linux-gnu/GL/default/lib/libEGL_indirect.so",
                "ln -s libEGL_mesa.so.0 /usr/lib/x86_64-linux-gnu/GL/default/lib/libEGL_indirect.so.0",
                "ln -s libGLX_mesa.so /usr/lib/x86_64-linux-gnu/GL/default/lib/libGLX_indirect.so",
                "ln -s libGLX_mesa.so.0 /usr/lib/x86_64-linux-gnu/GL/default/lib/libGLX_indirect.so.0",
                "mv /usr/lib/x86_64-linux-gnu/GL/default/share/vulkan /usr/lib/x86_64-linux-gnu/GL/default/vulkan"
           ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://anongit.freedesktop.org/git/mesa/mesa.git"
                },
                {
                    "type": "patch",
                    "path": "mesa-Fix-linkage-against-shared-glapi.patch"
                }
            ]
        }
    ]
}
